<div [formGroup]="form" class="detail-body">

    <natural-detail-header [listRoute]="['admin', 'product']" [model]="data.model" label="Produit" newLabel="Nouveau produit"
    >
        <a [routerLink]="['/larevuedurable/article', data.model.id]" color="primary" mat-raised-button>
            <natural-icon name="remove_red_eye"></natural-icon>
            Aperçu
        </a>

    </natural-detail-header>

    <mat-tab-group (selectedIndexChange)="changeTab($event)" [dynamicHeight]="true">
        <mat-tab label="Général">
            <div class="padding-top" fxLayout="column" fxLayoutGap="30px">
                <div fxLayout="column" fxLayout.gt-sm="row" fxLayoutGap="0" fxLayoutGap.gt-sm="30px">
                    <div fxFlex="66" fxLayout="column">

                        <div class="margin-bottom" fxLayout="row" fxLayoutAlign="start start" fxLayoutGap="20px">

                            <div fxFlex fxLayout="column">
                                <mat-form-field>
                                    <input (change)="update()" formControlName="name" matInput>
                                    <mat-label>Nom</mat-label>
                                    <mat-error *ngIf="form.get('name')?.hasError('maxlength')">
                                        Maximum {{form.get('name')?.errors.maxlength.requiredLength }} caractères
                                    </mat-error>
                                    <mat-error *ngIf="form.get('name')?.hasError('required')">Requis</mat-error>
                                </mat-form-field>

                                <mat-form-field>
                                    <input (change)="update()" formControlName="code" matInput maxlength="20">
                                    <mat-label>Code</mat-label>
                                    <mat-error *ngIf="form.get('code')?.hasError('maxlength')">
                                        Maximum {{form.get('code')?.errors.maxlength.requiredLength }} caractères
                                    </mat-error>
                                    <mat-error *ngIf="form.get('code')?.hasError('duplicateValue')">
                                        Ce code est déjà attribué à un produit
                                    </mat-error>
                                    <mat-error *ngIf="form.get('code')?.hasError('required')">Requis</mat-error>
                                </mat-form-field>
                            </div>
                        </div>

                        <mat-form-field>
                            <mat-label>Description courte</mat-label>
                            <textarea (change)="update()"
                                      [matAutosizeMinRows]="1"
                                      formControlName="shortDescription"
                                      matInput
                                      matTextareaAutosize
                            ></textarea>
                        </mat-form-field>

                        <mat-form-field>
                            <mat-label>Description complète</mat-label>
                            <textarea (change)="update()"
                                      [matAutosizeMinRows]="1"
                                      formControlName="description"
                                      matInput
                                      matTextareaAutosize
                            ></textarea>
                        </mat-form-field>

                    </div>

                    <div fxFlex="33" fxLayout="column" fxLayoutGap="20px">

                        <div class="margin-bottom" fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="20px">
                            <h2 class="mat-h2 no-margin" fxFlex>Disponible à la vente</h2>
                            <mat-slide-toggle (change)="update()" formControlName="isActive">Disponible</mat-slide-toggle>
                        </div>

                        <mat-form-field>
                            <mat-label>Numéro de revue</mat-label>
                            <input (change)="update()" formControlName="reviewNumber" matInput type="number">
                            <mat-hint>Numéro de la revue (seulement pour les revues ! ne pas saisir pour les articles)</mat-hint>
                        </mat-form-field>

                        <mat-form-field>
                            <mat-label>Durée de lecture</mat-label>
                            <input (change)="update()" formControlName="readingDuration" matInput type="number">
                            <mat-hint>Saisir un nombre de minutes</mat-hint>
                        </mat-form-field>

                        <mat-divider></mat-divider>

                        <h2 class="mat-h2">Prix</h2>

                        <mat-form-field>
                            <mat-label>Prix par unité (CHF)</mat-label>
                            <input (change)="update();"
                                   formControlName="pricePerUnitCHF"
                                   matInput
                                   required="required"
                                   step="0.01"
                                   type="number"
                            >
                            <div matSuffix>CHF</div>
                            <mat-error *ngIf="form.get('pricePerUnitCHF')?.hasError('required')">Requis</mat-error>
                        </mat-form-field>

                        <mat-form-field>
                            <mat-label>Prix par unité (EUR)</mat-label>
                            <input (change)="update();"
                                   formControlName="pricePerUnitEUR"
                                   matInput
                                   required="required"
                                   step="0.01"
                                   type="number"
                            >
                            <div matSuffix>EUR</div>
                            <mat-error *ngIf="form.get('pricePerUnitEUR')?.hasError('required')">Requis</mat-error>
                        </mat-form-field>

                        <mat-form-field class="margin-top">
                            <mat-label>Remarques internes</mat-label>
                            <textarea (change)="update()"
                                      [matAutosizeMaxRows]="3"
                                      formControlName="internalRemarks"
                                      matInput
                                      matTextareaAutosize
                            ></textarea>
                        </mat-form-field>

                    </div>
                </div>

                <mat-divider></mat-divider>

                <div fxLayout="column" fxLayout.gt-sm="row" fxLayoutGap="0" fxLayoutGap.gt-sm="30px">

                    <div fxFlex="66" fxLayout="column">
                        <h2 class="mat-h2">Illustration</h2>
                        <app-file (modelChange)="newImage($event, 'illustration')"
                                  [height]="300"
                                  [model]="data.model.illustration"
                                  [service]="imageService"
                                  [style.borderRadius.px]="4"
                                  [style.marginLeft.px]="2"
                                  action="upload"
                                  class="mat-elevation-z2"
                        ></app-file>
                    </div>

                    <div fxFlex="33" fxLayout="column">
                        <h2 class="mat-h2">Aperçu de l'article</h2>
                        <app-file (modelChange)="newImage($event, 'image')"
                                  [height]="300"
                                  [model]="data.model.image"
                                  [service]="imageService"
                                  [style.borderRadius.px]="4"
                                  [style.marginLeft.px]="2"
                                  action="upload"
                                  class="mat-elevation-z2"
                        ></app-file>
                    </div>
                </div>

                <mat-divider></mat-divider>

                <div fxLayout="column" fxLayout.gt-sm="row" fxLayoutGap="0" fxLayoutGap.gt-sm="30px">
                    <div fxFlex="66" fxLayout="column">

                        <div *ngIf="data.model.id">
                            <h2 class="mat-h2">Tags</h2>
                            <natural-relations [filter]="{groups: [{conditions: [{products: {have: {values: [data.model.id]}}}]}]}"
                                               [main]="data.model"
                                               [service]="productTagService"
                                               placeholder="Ajouter un tag"
                            >
                                <ng-template let-item="item">
                                    <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="10px">
                                        <!-- TODO : link to products list filtred by tag -->
                                        <ngx-avatar [bgColor]="item.color" [name]="item.name" [size]="32"></ngx-avatar>
                                        <natural-table-button [label]="item.name" [navigate]="['/admin/product']"></natural-table-button>
                                    </div>
                                </ng-template>
                            </natural-relations>
                        </div>
                    </div>
                </div>

                <natural-stamp [item]="data.model"></natural-stamp>

            </div>
        </mat-tab>

        <mat-tab *ngIf="data.model.id" label="Ventes">
            <app-order-lines [contextColumns]="['creationDate', 'quantity', 'owner', 'balanceCHF', 'balanceEUR']"
                             [contextVariables]="orderLinesVariables"
                             [persistSearch]="false"
                             [showTotals]="true"
            ></app-order-lines>
        </mat-tab>

    </mat-tab-group>

    <natural-fixed-button-detail (create)="create()" (delete)="delete()" *ngIf="showFabButton" [form]="form" [model]="data.model"
    ></natural-fixed-button-detail>

</div>
