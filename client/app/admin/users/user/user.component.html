<div [formGroup]="form" class="detail-body">

    <natural-detail-header newLabel="Nouvel utilisateur" label="Utilisateur" [model]="data.model" [listRoute]="['admin', 'user']">
    </natural-detail-header>

    <mat-tab-group [dynamicHeight]="true" (selectedIndexChange)="changeTab($event)">
        <mat-tab label="Général">
            <div fxLayout="column" fxLayoutGap="30px" class="padding-top">
                <div fxLayout="column" fxLayout.gt-md="row" fxLayoutGap="0" fxLayoutGap.gt-sm="30px">
                    <div fxFlex="66" fxLayout="column">

                        <h2 class="mat-title">Coordonnées</h2>

                        <div fxLayout="row" fxLayoutGap="10px">
                            <mat-form-field fxFlex>
                                <mat-label>Prénom</mat-label>
                                <input matInput formControlName="firstName" (change)="update()">
                                <mat-error *ngIf="form.get('firstName')?.hasError('maxlength')">
                                    Maximum {{form.get('firstName')?.errors.maxlength.requiredLength}} caractères
                                </mat-error>
                                <mat-error *ngIf="form.get('firstName')?.hasError('required')">Requis</mat-error>
                            </mat-form-field>

                            <mat-form-field fxFlex>
                                <mat-label>Nom de famille</mat-label>
                                <input matInput formControlName="lastName" (change)="update()">
                                <mat-error *ngIf="form.get('lastName')?.hasError('maxlength')">
                                    Maximum {{form.get('lastName')?.errors.maxlength.requiredLength}} caractères
                                </mat-error>
                                <mat-error *ngIf="form.get('lastName')?.hasError('required')">Requis</mat-error>
                            </mat-form-field>

                        </div>

                        <app-address [form]="form" (change)="update()"></app-address>

                        <div fxLayout="row" fxLayoutGap="10px">

                            <mat-form-field fxFlex>
                                <mat-label>Téléphone</mat-label>
                                <input matInput formControlName="phone" (change)="update()">
                            </mat-form-field>

                        </div>

                    </div>

                    <div fxFlex="33" fxLayout="column">
                        <h2 class="mat-title">Compte</h2>
                        <mat-form-field>
                            <mat-label>email</mat-label>
                            <input matInput formControlName="email" (change)="update()">
                            <mat-error *ngIf="form.get('email')?.hasError('required')">Requis</mat-error>
                            <mat-error *ngIf="form.get('email')?.hasError('email')">Adresse email invalide</mat-error>
                        </mat-form-field>

                        <mat-form-field>
                            <mat-label>Nom d'utilisateur</mat-label>
                            <input matInput formControlName="login" (change)="update()">
                            <mat-error *ngIf="form.get('login')?.hasError('maxlength')">
                                Maximum {{form.get('login')?.errors.maxlength.requiredLength}} caractères
                            </mat-error>
                            <mat-error *ngIf="form.get('login')?.hasError('required')">Requis</mat-error>
                            <mat-error *ngIf="form.get('login')?.hasError('invalid')">{{ form.get('login')?.getError('invalid') }}</mat-error>
                        </mat-form-field>

                        <mat-divider class="margin-bottom"></mat-divider>

                        <h2 class="mat-title">État</h2>


                        <natural-select-enum enumName="UserRole" formControlName="role" (selectionChange)="update()" placeholder="Rôle"
                        ></natural-select-enum>

                        <mat-form-field>
                            <mat-label>Membre depuis</mat-label>
                            <input matInput formControlName="membershipBegin" [matDatepicker]="picker1" (dateChange)="update()">

                            <div matSuffix xLayout="row" fxLayoutAlign="start center">
                                <mat-datepicker-toggle [for]="picker1"></mat-datepicker-toggle>
                                <mat-datepicker #picker1></mat-datepicker>

                                <button mat-icon-button
                                        *ngIf="form.get('membershipBegin')?.value"
                                        (click)="form.get('membershipBegin')?.setValue(null); update()"
                                >
                                    <natural-icon name="close"></natural-icon>
                                </button>
                            </div>

                        </mat-form-field>

                        <mat-form-field>
                            <mat-label>Membre jusqu'à</mat-label>
                            <input matInput formControlName="membershipEnd" [matDatepicker]="picker2" (dateChange)="update()">

                            <div matSuffix xLayout="row" fxLayoutAlign="start center">
                                <mat-datepicker-toggle [for]="picker2"></mat-datepicker-toggle>
                                <mat-datepicker #picker2></mat-datepicker>

                                <button mat-icon-button
                                        *ngIf="form.get('membershipEnd')?.value"
                                        (click)="form.get('membershipEnd')?.setValue(null); update()"
                                >
                                    <natural-icon name="close"></natural-icon>
                                </button>
                            </div>

                        </mat-form-field>
                    </div>
                </div>

                <mat-divider></mat-divider>

                <mat-divider *ngIf="data.model.id"></mat-divider>

                <div fxLayout="column" fxLayout.gt-sm="row" fxLayoutGap="0" fxLayoutGap.gt-sm="30px" *ngIf="data.model.id">

                    <div fxFlex="66" fxLayout="column">
                        <h2 class="mat-title">Tags</h2>
                        <natural-relations [main]="data.model"
                                           [service]="userTagService"
                                           [filter]="{groups: [{conditions: [{users: {have: {values: [data.model.id]}}}]}]}"
                                           placeholder="Ajouter un tag"
                        >
                            <ng-template let-item="item">
                                <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="10px">
                                    <!-- TODO : link to users list filtred by tag -->
                                    <ngx-avatar [bgColor]="item.color" [name]="item.name" [size]="36"></ngx-avatar>
                                    <natural-table-button [navigate]="['/admin/user', item.id]" [label]="item.name"></natural-table-button>
                                </div>
                            </ng-template>
                        </natural-relations>
                    </div>

                    <div fxFlex="33" fxLayout="column">

                        <h2 class="mat-title">Commentaires</h2>

                        <mat-form-field>
                            <mat-label>Remarques internes</mat-label>
                            <textarea matInput
                                      formControlName="internalRemarks"
                                      (change)="update()"
                                      matTextareaAutosize
                                      [matAutosizeMinRows]="3"
                            ></textarea>
                        </mat-form-field>

                    </div>
                </div>

                <mat-divider></mat-divider>

                <div fxLayout="column" fxLayoutGap="15px">
                    <natural-stamp [item]="data.model"></natural-stamp>

                    <div>
                        <span class="mat-body-2">Première connexion :</span>
                        {{ data.model.firstLogin | date: 'd MMM y - HH:mm' }}
                    </div>

                    <div>
                        <span class="mat-body-2">Dernière connexion :</span>
                        {{ data.model.lastLogin | date: 'd MMM y - HH:mm' }}
                    </div>

                    <div *ngIf="data.model.resignDate && data.model.status == 'archived'">
                        <span class="mat-body-2">Démission le :</span>
                        {{ data.model.resignDate | date: 'd MMM y - HH:mm' }}
                    </div>
                </div>

            </div>

        </mat-tab>

    </mat-tab-group>

    <natural-fixed-button-detail *ngIf="showFabButton" [form]="form" [model]="data.model" (create)="create()"></natural-fixed-button-detail>

</div>
